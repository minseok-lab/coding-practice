name: Organize Codetree Files

on:
  push:
    branches:
      - main 

jobs:
  organize-files:
    runs-on: ubuntu-latest

    # 작업(job)이 레포지토리 내용을 '쓰기'할 수 있도록 권한을 부여합니다.
    permissions:
      contents: write

    if: contains(github.event.head_commit.message, 'Codetree')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # [수정됨] 2단계: 폴더 이동 또는 내용물 병합
      - name: Move or Merge Codetree problem folders
        run: |
          mkdir -p Codetree
          shopt -s nullglob # 일치하는 파일이 없을 때 오류 방지
          moved_something=0
          
          # 루트에서 숫자 이름으로 된 폴더를 찾습니다 (예: 251112)
          for dir in *; do
            if [[ -d "$dir" && "$dir" =~ ^[0-9]+$ ]]; then
              
              # 이동할 목표 폴더 경로 (예: Codetree/251112)
              DEST_DIR="Codetree/$dir"
              
              if [ -d "$DEST_DIR" ]; then
                # Case 1: 목표 폴더가 이미 존재함 (오늘 푼 추가 문제)
                echo "Destination '$DEST_DIR' exists. Merging contents from root '$dir'..."
                
                # 루트 폴더(251112) 안의 내용물(예: '달에서 무게 구하기' 폴더)을 순회
                for item in "$dir"/*; do
                  base_item=$(basename "$item")
                  final_dest="$DEST_DIR/$base_item"
                  
                  # 만약 목표 폴더에도 같은 이름의 항목(예: '달에서 무게 구하기')이 이미 있다면?
                  # (같은 문제를 다시 푼 경우)
                  # -> 기존 것을 지우고 새 것으로 덮어쓰기 위해 git rm 실행
                  if [ -e "$final_dest" ]; then
                    echo "Item '$base_item' already exists. Removing old version at '$final_dest'..."
                    git rm -rf "$final_dest"
                  fi
                  
                  # 루트의 항목을 목표 폴더 안으로 이동
                  echo "Moving '$item' to '$DEST_DIR/'"
                  git mv "$item" "$DEST_DIR/"
                  moved_something=1
                done
                
                # 내용물을 다 옮긴 후, 비어있는 루트 폴더 삭제
                rmdir "$dir"
                
              else
                # Case 2: 목표 폴더가 없음 (오늘 푼 첫 문제)
                echo "Moving new directory '$dir' to 'Codetree/'"
                git mv "$dir" "Codetree/"
                moved_something=1
              fi
            fi
          done
          
          if [ $moved_something -eq 0 ]; then
            echo "No new root-level Codetree folders to move or merge."
          fi

      # 3. 변경사항(이동 또는 병합)을 자동으로 커밋
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "auto: Organize Codetree files into subfolder"
          # git rm 명령어도 커밋에 포함시키기 위해 --all 옵션 추가
          commit_options: '--all'
