name: Organize Codetree Files

on:
  push:
    branches:
      - main 

jobs:
  organize-files:
    runs-on: ubuntu-latest
    permissions:
      contents: write # git push를 위한 권한
    if: contains(github.event.head_commit.message, 'Codetree')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 1단계: 폴더 이동 또는 내용물 병합
      - name: Move or Merge Codetree problem folders
        run: |
          mkdir -p Codetree
          shopt -s nullglob
          moved_something=0
          
          # 루트에서 숫자 이름으로 된 폴더를 찾습니다 (예: 251112)
          for dir in *; do
            if [[ -d "$dir" && "$dir" =~ ^[0-9]+$ ]]; then
              DEST_DIR="Codetree/$dir"
              if [ -d "$DEST_DIR" ]; then
                # Case 1: 이미 존재함 (오늘 푼 추가 문제)
                echo "Destination '$DEST_DIR' exists. Merging contents from root '$dir'..."
                for item in "$dir"/*; do
                  base_item=$(basename "$item")
                  final_dest="$DEST_DIR/$base_item"
                  if [ -e "$final_dest" ]; then
                    git rm -rf "$final_dest"
                  fi
                  git mv "$item" "$DEST_DIR/"
                  moved_something=1
                done
                rmdir "$dir"
              else
                # Case 2: 없음 (오늘 푼 첫 문제)
                echo "Moving new directory '$dir' to 'Codetree/'"
                git mv "$dir" "Codetree/"
                moved_something=1
              fi
            fi
          done
          
          # [수정] 이동한 내역이 있는지 여부를 'id'로 출력합니다.
          echo "moved_something=${moved_something}" >> $GITHUB_OUTPUT
        id: move # 이 스텝의 ID

      # [수정됨] 2단계: 수동으로 Git 커밋 및 푸시
      - name: Commit and Push changes
        # 1단계에서 'moved_something'이 1일 때만 (즉, 변경 사항이 있을 때만) 실행
        if: steps.move.outputs.moved_something == '1'
        run: |
          # 1. 커밋을 위한 Git 유저 설정
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          
          # 2. 변경 사항(파일 이동/병합)을 먼저 커밋
          git commit -a -m "auto: Organize Codetree files into subfolder"
          
          # 3. 그 사이에 깃허브에 다른 커밋이 왔을 경우를 대비해 rebase로 pull
          git pull origin main --rebase
          
          # 4. 최종본을 깃허브로 푸시
          git push origin main
